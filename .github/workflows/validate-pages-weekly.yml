name: Weekly Validation of Pages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 17 * * 0"

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # ★ ここは continue-on-error を使わず、終了コードを受け取る
      #   ただし後続を必ず走らせたいので、以降の step は if: always() にする
      - name: Run tests
        id: run_tests
        run: |
          set +e
          npx playwright test
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          set -e

      # ★ test-results.jsonの内容をデバッグ（失敗原因の切り分け用）
      - name: Debug test-results.json summary
        if: always()
        run: |
          ls -la test-results.json || true
          node -e "const fs=require('fs'); const p='test-results.json'; if(!fs.existsSync(p)){console.log('NO test-results.json'); process.exit(0);} const j=JSON.parse(fs.readFileSync(p,'utf8')); const s=JSON.stringify(j); console.log('contains \"failed\"?', s.includes('failed')); console.log('top keys:', Object.keys(j)); console.log('has suites?', !!j.suites, 'suites length:', (j.suites||[]).length);"

      # ★ 失敗しても必ず解析する
      - name: Parse test results
        if: always()
        run: |
          if [ -f test-results.json ]; then
            # スクリプトの標準出力のみをYAMLファイルに（標準エラー出力はログに分離）
            node scripts/parse-test-results.js test-results.json > test-failures.yaml 2>parse-errors.log || {
              echo "Warning: Test result parsing may have failed, check parse-errors.log"
              # 解析に失敗した場合でも空のYAMLファイルを作成
              echo "failed_tests:" > test-failures.yaml
              echo "  []" >> test-failures.yaml
              echo "" >> test-failures.yaml
              echo "total_failed: 0" >> test-failures.yaml
              echo "total_tests: 12" >> test-failures.yaml
            }
            # エラーログがあれば表示
            if [ -s parse-errors.log ]; then
              echo "Parse errors:"
              cat parse-errors.log
            fi
            # YAMLファイルが正しく生成されたか確認
            if [ ! -f test-failures.yaml ] || [ ! -s test-failures.yaml ]; then
              echo "Error: test-failures.yaml was not created or is empty"
              echo "failed_tests:" > test-failures.yaml
              echo "  []" >> test-failures.yaml
              echo "" >> test-failures.yaml
              echo "total_failed: 0" >> test-failures.yaml
              echo "total_tests: 12" >> test-failures.yaml
            else
              echo "test-failures.yaml created successfully ($(wc -c < test-failures.yaml) bytes)"
            fi
          else
            echo "test-results.json not found, creating empty test-failures.yaml"
            echo "failed_tests:" > test-failures.yaml
            echo "  []" >> test-failures.yaml
            echo "" >> test-failures.yaml
            echo "total_failed: 0" >> test-failures.yaml
            echo "total_tests: 12" >> test-failures.yaml
          fi

      # ★ 先方向けメール本文を作成（簡潔で読みやすい形式）
      - name: Build client mail body
        if: always()
        run: |
          # 成功/失敗判定
          if [ "${{ steps.run_tests.outputs.exit_code }}" = "0" ]; then
            echo "自動チェックを実行しました。" > mail-body-client.txt
            echo "" >> mail-body-client.txt
            echo "結果：成功（問題は検知されませんでした）" >> mail-body-client.txt
            echo "" >> mail-body-client.txt
            echo "何かご不明点があれば本メールにご返信ください。" >> mail-body-client.txt
          else
            echo "自動チェックを実行しました。" > mail-body-client.txt
            echo "" >> mail-body-client.txt
            echo "結果：失敗（不具合を検知）" >> mail-body-client.txt
            echo "" >> mail-body-client.txt
            echo "内容：" >> mail-body-client.txt

            # test-failures.yaml があれば、失敗したテストを抽出（最大3件まで）
            if [ -f test-failures.yaml ] && [ -s test-failures.yaml ]; then
              # Node.jsでYAMLを解析してメール本文を生成（確実性のため）
              node -e "
                const fs = require('fs');
                const content = fs.readFileSync('test-failures.yaml', 'utf-8');
                const lines = content.split('\n');
                let currentTest = null;
                let testCount = 0;
                const maxTests = 3;
                
                for (const line of lines) {
                  if (testCount >= maxTests) break;
                  
                  // 新しいテスト項目の開始
                  if (line.match(/^\s*-\s+id:/)) {
                    if (currentTest && currentTest.name) {
                      console.log('- テスト: ' + currentTest.name);
                      if (currentTest.page) console.log('- 対象ページ: ' + currentTest.page);
                      console.log('');
                      testCount++;
                    }
                    currentTest = { name: '', page: '' };
                  }
                  
                  // name を抽出
                  if (currentTest && line.match(/^\s+name:\s*\"/)) {
                    const match = line.match(/name:\s*\"([^\"]*)\"/);
                    if (match) {
                      currentTest.name = match[1].replace(/\\\\\"/g, '\"');
                    }
                  }
                  
                  // page を抽出
                  if (currentTest && line.match(/^\s+page:\s*\"/)) {
                    const match = line.match(/page:\s*\"([^\"]*)\"/);
                    if (match) {
                      currentTest.page = match[1].replace(/\\\\\"/g, '\"');
                    }
                  }
                }
                
                // 最後のテストを出力
                if (currentTest && currentTest.name && testCount < maxTests) {
                  console.log('- テスト: ' + currentTest.name);
                  if (currentTest.page) console.log('- 対象ページ: ' + currentTest.page);
                  console.log('');
                  testCount++;
                }
                
                // 追加の失敗テストがある場合
                const totalMatch = content.match(/total_failed:\s*(\d+)/);
                if (totalMatch) {
                  const totalFailed = parseInt(totalMatch[1], 10);
                  if (totalFailed > testCount) {
                    console.log('※ 他に ' + (totalFailed - testCount) + ' 件のテストが失敗しています。');
                    console.log('');
                  }
                }
              " >> mail-body-client.txt
            else
              echo "- 詳細情報の取得に失敗しました（ログを確認中です）" >> mail-body-client.txt
            fi

            echo "" >> mail-body-client.txt
            echo "※ 失敗時の画面キャプチャを添付しています。" >> mail-body-client.txt
            echo "何かご不明点があれば本メールにご返信ください。" >> mail-body-client.txt
          fi

      - name: Collect failure screenshots
        if: always()
        run: |
          mkdir -p mail-attachments
          find test-results -type f -name "test-failed-*.png" | head -n 5 | while read f; do
            cp "$f" mail-attachments/ || true
          done

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 14

      - name: Upload test failures YAML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-failures
          path: test-failures.yaml
          retention-days: 14

      # ★ メール本文を読み込んでoutputsに設定
      - name: Read client mail body
        if: always()
        id: client_body
        run: |
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat mail-body-client.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ★ 件名を設定
      - name: Set mail subject
        if: always()
        id: subject
        run: |
          if [ "${{ steps.run_tests.outputs.exit_code }}" = "0" ]; then
            echo "value=【サイト自動チェック】：問題ありませんでした" >> $GITHUB_OUTPUT
          else
            echo "value=【サイト自動チェック】：不具合を検知しました" >> $GITHUB_OUTPUT
          fi

      # ★ メール送信（成功時）
      - name: Send mail (success)
        if: ${{ steps.run_tests.outputs.exit_code == '0' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.subject.outputs.value }}
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: ${{ steps.client_body.outputs.body }}

      # ★ メール送信（失敗時・添付ファイルあり）
      - name: Send mail (failure)
        if: ${{ steps.run_tests.outputs.exit_code != '0' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.subject.outputs.value }}
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: ${{ steps.client_body.outputs.body }}
          attachments: |
            mail-attachments/*

      # ★ 失敗時にジョブをFailにする
      - name: Fail job if tests failed
        if: ${{ steps.run_tests.outputs.exit_code != '0' }}
        run: exit 1
